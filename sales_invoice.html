<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª (Ø£Ù…Ø± Ø´ØºÙ„)</title>
    <!-- Ù…ÙƒØªØ¨Ø© SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 10px; max-width: 1200px; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h2 { color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #475569; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 5px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #1e293b; color: white; padding: 10px; font-size: 13px; text-align: center; }
        td { padding: 5px; border-bottom: 1px solid #eee; }
        td input, td select { width: 100%; border: 1px solid #ddd; padding: 8px; border-radius: 4px; text-align: center; font-size: 13px; }
        .readonly-input { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; font-weight: bold; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; font-size: 14px; }
        .btn-add { background: #3b82f6; margin-top: 10px; font-size: 12px; }
        .btn-save { background: #10b981; width: 100%; margin-top: 20px; font-size: 16px; padding: 15px; justify-content: center; }
        .btn-del { background: #ef4444; padding: 5px 10px; font-size: 12px; }
        .btn-list { background: #64748b; }
        .btn-print { background: #333; }
        .btn-excel { background: #16a34a; }
        .btn-import { background: #f59e0b; }

        .toolbar { display: flex; gap: 10px; }
        
        .tax-box { background: #ecfdf5; padding: 15px; border-radius: 8px; border: 1px solid #10b981; margin-top: 20px; width: 400px; float: left; }
        .tax-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; }
        .tax-row input { width: 80px; padding: 5px; text-align: center; }
        .final-row { border-top: 2px solid #10b981; padding-top: 10px; margin-top: 10px; font-size: 18px; color: #059669; }
        
        #msg { display: none; padding: 15px; margin-bottom: 15px; border-radius: 5px; text-align: center; font-weight: bold; }
        
        @media print {
            .no-print, .btn, .toolbar { display: none !important; }
            .card { border: none; box-shadow: none; width: 100%; max-width: 100%; padding: 0; }
            input, select { border: none; background: transparent; padding: 0; }
            h2 { border-bottom: 2px solid #000; }
            th { background: #ccc !important; color: #000 !important; }
            .tax-box { border: 2px solid #000; }
        }
    </style>
</head>
<body>

<div class="card">
    <h2>
        ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª (Ø£Ù…Ø± Ø´ØºÙ„)
        <div class="toolbar no-print">
            <button class="btn btn-excel" onclick="exportToExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn btn-import" onclick="document.getElementById('excelFile').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
            <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none" onchange="importFromExcel(this)">
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            <a href="sales_list.html" class="btn btn-list">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„</a>
        </div>
    </h2>
    <div id="msg"></div>
    <input type="hidden" id="editId">

    <div class="row">
        <div class="col">
            <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
            <!-- ğŸ‘‡ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø´Ù„Øª readonly Ø¹Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªÙƒØªØ¨ Ø¨Ø§ÙŠØ¯Ùƒ ğŸ‘‡ -->
            <input id="invNum" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ Ù„Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ" style="color:#2563eb; font-weight:bold;">
        </div>
        <div class="col"><label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label><select id="customer"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ --</option></select></div>
        <div class="col"><label>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><select id="car" onchange="populateCarParts()"><option value="">-- Ø§Ø®ØªØ± Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø¹ --</option></select></div>
        <div class="col"><label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label><select id="serviceType"><option value="ØªØºÙ„ÙŠÙ ÙƒØ§Ù…Ù„">ØªØºÙ„ÙŠÙ ÙƒØ§Ù…Ù„</option><option value="Ø­Ù…Ø§ÙŠØ©">Ø­Ù…Ø§ÙŠØ© (PPF)</option><option value="ØªÙ„Ù…ÙŠØ¹">ØªÙ„Ù…ÙŠØ¹</option><option value="Ø¹Ø§Ø²Ù„">Ø¹Ø§Ø²Ù„ Ø­Ø±Ø§Ø±ÙŠ</option></select></div>
        <div class="col"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="date"></div>
    </div>

    <table id="itemsTable">
        <thead>
            <tr>
                <th width="20%">Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                <th width="25%">Ø§Ù„Ø®Ø§Ù…Ø©</th>
                <th width="10%">Ø·ÙˆÙ„</th>
                <th width="10%">Ø¹Ø±Ø¶</th>
                <th width="10%">Ù…Ø³Ø§Ø­Ø©</th>
                <th width="10%">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th width="15%">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th width="5%" class="no-print">x</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="btn btn-add no-print" onclick="addEmptyRow()">+ Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© ÙŠØ¯ÙˆÙŠØ©</button>

    <div style="clear:both"></div>

    <div class="tax-box">
        <div class="tax-row">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù:</span> <span id="subtotal">0.00</span>
        </div>
        <div class="tax-row">
            <span>+ Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</span> <input type="number" id="extraCost" value="0" oninput="calcTotal()">
        </div>
        <div class="tax-row">
            <span>- Ø®ØµÙ… Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡:</span> <input type="number" id="discount" value="0" oninput="calcTotal()">
        </div>
        <div class="tax-row">
            <label><input type="checkbox" id="hasVat" onchange="calcTotal()"> + Ø¶.Ù‚.Ù… (14%):</label> <span id="vatVal">0.00</span>
        </div>
        <div class="tax-row">
            <label><input type="checkbox" id="hasWht" onchange="calcTotal()"> - Ø¶.Ø®ØµÙ… (1%):</label> <span id="whtVal">0.00</span>
        </div>
        <div class="tax-row final-row">
            <span>Ø§Ù„ØµØ§ÙÙŠ:</span> <span id="finalTotal">0.00</span>
        </div>
    </div>

    <div style="clear:both"></div>
    <button class="btn btn-save no-print" onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>

<script>
    const API = 'http://localhost:5000/api';
    let products = [], carsData = [];

    window.onload = async () => {
        document.getElementById('date').valueAsDate = new Date();
        await loadData();
        
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if(id) loadForEdit(id);
    };

    async function loadData() {
        try {
            const [c, p, r] = await Promise.all([fetch(`${API}/customers`), fetch(`${API}/products`), fetch(`${API}/cars`)]);
            const customers = await c.json(); products = await p.json(); carsData = await r.json();

            const custSel = document.getElementById('customer');
            customers.forEach(c => custSel.innerHTML += `<option value="${c._id}">${c.name}</option>`);

            const carSel = document.getElementById('car');
            carsData.forEach(c => carSel.innerHTML += `<option value="${c._id}">${c.brand} ${c.model}</option>`);
        } catch(e) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„'); }
    }

    function populateCarParts() {
        const carId = document.getElementById('car').value;
        const tbody = document.querySelector('tbody');
        if(!carId) return; 
        
        tbody.innerHTML = '';
        const car = carsData.find(c => c._id === carId);
        if (car && car.parts) {
            car.parts.forEach(part => createRow({ partName: part.name, length: part.lengthCM, width: part.widthCM, area: part.areaCM2 }));
        } else { createRow(); }
        calcTotal();
    }

    function createRow(d = {}) {
        const tbody = document.querySelector('tbody');
        let opts = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø§Ù…Ø©</option>';
        products.forEach(p => opts += `<option value="${p._id}" data-price="${p.pricing?.unitSalePrice||0}" ${d.product===p._id?'selected':''}>${p.name}</option>`);

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input class="part-name readonly-input" value="${d.partName||''}"></td>
            <td><select class="prod" onchange="updPrice(this)">${opts}</select></td>
            <td><input type="number" class="len readonly-input" value="${d.length||0}" readonly></td>
            <td><input type="number" class="wid readonly-input" value="${d.width||0}" readonly></td>
            <td><input type="number" class="area readonly-input" value="${d.area||0}" readonly></td>
            <td><input type="number" class="unit-price" value="${d.priceUnit||0}" readonly style="color:#666"></td>
            <td><input type="number" class="row-total" value="${d.lineTotal||0}" oninput="calcTotal()" style="color:green;font-weight:bold"></td>
            <td class="no-print"><button class="btn-del" onclick="this.closest('tr').remove();calcTotal()">X</button></td>
        `;
        tbody.appendChild(tr);
        if(d.product) updPrice(tr.querySelector('.prod'), false); 
    }

    function addEmptyRow() { createRow({ partName: '', length: 0, width: 0, area: 0 }); }

    function updPrice(el, resetTotal = true) {
        const row = el.closest('tr');
        const price = parseFloat(el.options[el.selectedIndex].getAttribute('data-price')) || 0;
        const area = parseFloat(row.querySelector('.area').value) || 0;
        row.querySelector('.unit-price').value = price;
        if(resetTotal) row.querySelector('.row-total').value = (area * price).toFixed(2);
        calcTotal();
    }

    function calcTotal() {
        let sub = 0;
        document.querySelectorAll('.row-total').forEach(i => sub += parseFloat(i.value)||0);
        document.getElementById('subtotal').innerText = sub.toFixed(2);

        const extra = parseFloat(document.getElementById('extraCost').value)||0;
        const disc = parseFloat(document.getElementById('discount').value)||0;
        
        let taxable = (sub + extra) - disc;
        let vat = document.getElementById('hasVat').checked ? taxable * 0.14 : 0;
        let wht = document.getElementById('hasWht').checked ? sub * 0.01 : 0;

        document.getElementById('vatVal').innerText = vat.toFixed(2);
        document.getElementById('whtVal').innerText = wht.toFixed(2);
        document.getElementById('finalTotal').innerText = (taxable + vat - wht).toFixed(2);
    }

    async function saveInvoice() {
        const items = [];
        document.querySelectorAll('tbody tr').forEach(tr => {
            if(tr.querySelector('.prod').value) {
                items.push({
                    product: tr.querySelector('.prod').value,
                    partName: tr.querySelector('.part-name').value,
                    lengthCM: tr.querySelector('.len').value,
                    widthCM: tr.querySelector('.wid').value,
                    area: tr.querySelector('.area').value,
                    price: tr.querySelector('.row-total').value
                });
            }
        });

        if(items.length === 0) { alert('Ø£Ø¶Ù ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }

        const id = document.getElementById('editId').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API}/sales/${id}` : `${API}/sales`;

        // ğŸ‘‡ Ù‚Ø±Ø§Ø¡Ø© Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ÙŠØ¯ÙˆÙŠ Ø£Ùˆ ØªÙ„Ù‚Ø§Ø¦ÙŠ) ğŸ‘‡
        const manualInvNum = document.getElementById('invNum').value.trim();
        
        const data = {
            invoiceNumber: manualInvNum || (id ? undefined : 'INV-'+Date.now()), // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ Ø£Ùˆ ÙˆÙ„Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ùˆ ÙØ§Ø¶ÙŠ
            date: document.getElementById('date').value,
            customer: document.getElementById('customer').value,
            carModel: document.getElementById('car').value,
            serviceType: document.getElementById('serviceType').value,
            items: items,
            subtotal: parseFloat(document.getElementById('subtotal').innerText),
            totalExtraCosts: parseFloat(document.getElementById('extraCost').value)||0,
            totalDiscount: parseFloat(document.getElementById('discount').value)||0,
            totalTax: parseFloat(document.getElementById('vatVal').innerText)||0,
            whtAmount: parseFloat(document.getElementById('whtVal').innerText)||0,
            finalTotal: parseFloat(document.getElementById('finalTotal').innerText)
        };

        try {
            const res = await fetch(url, { method: method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            const json = await res.json();
            if(res.ok) { 
                const msg = document.getElementById('msg');
                msg.innerText = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­'; 
                msg.style.display='block'; 
                msg.style.background='#dcfce7';
                msg.style.color='#166534';
                setTimeout(() => window.location.href = 'sales_list.html', 1500); 
            } else { alert('Ø®Ø·Ø£: ' + json.message); }
        } catch(e) { alert('Ø®Ø·Ø£ Ø§ØªØµØ§Ù„'); }
    }

    function exportToExcel() {
        const customer = document.getElementById('customer').options[document.getElementById('customer').selectedIndex].text;
        const car = document.getElementById('car').options[document.getElementById('car').selectedIndex].text;
        const date = document.getElementById('date').value;
        // ğŸ‘‡ Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¥ÙƒØ³ÙŠÙ„ ğŸ‘‡
        const invNum = document.getElementById('invNum').value || "Ø¬Ø¯ÙŠØ¯";
        
        let data = [];
        data.push(["ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª"]);
        data.push(["Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©", invNum]); // Ù‡Ù†Ø§
        data.push(["Ø§Ù„Ø¹Ù…ÙŠÙ„", customer]);
        data.push(["Ø§Ù„Ø³ÙŠØ§Ø±Ø©", car]);
        data.push(["Ø§Ù„ØªØ§Ø±ÙŠØ®", date]);
        data.push([]); 

        data.push(["Ø§Ù„Ù‚Ø·Ø¹Ø©", "Ø§Ù„Ø®Ø§Ù…Ø©", "Ø·ÙˆÙ„", "Ø¹Ø±Ø¶", "Ù…Ø³Ø§Ø­Ø©", "Ø§Ù„Ø³Ø¹Ø±", "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ"]);

        document.querySelectorAll('tbody tr').forEach(tr => {
            const prodSelect = tr.querySelector('.prod');
            const prodName = prodSelect.options[prodSelect.selectedIndex]?.text || '';
            data.push([
                tr.querySelector('.part-name').value,
                prodName,
                tr.querySelector('.len').value,
                tr.querySelector('.wid').value,
                tr.querySelector('.area').value,
                tr.querySelector('.unit-price').value,
                tr.querySelector('.row-total').value
            ]);
        });

        data.push([]);
        data.push(["Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", document.getElementById('subtotal').innerText]);
        data.push(["Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©", document.getElementById('extraCost').value]);
        data.push(["Ø§Ù„ØµØ§ÙÙŠ", document.getElementById('finalTotal').innerText]);

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Invoice");
        XLSX.writeFile(wb, `Invoice_${customer}_${date}.xlsx`);
    }

    function importFromExcel(input) {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

            // 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
            // Ù†ØªÙˆÙ‚Ø¹ Ø£Ù† Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ø§Ù„ØµÙ 2 Ø§Ù„Ø¹Ù…ÙˆØ¯ 2 (Index 1, 1) Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            if(jsonData[1] && jsonData[1][1]) document.getElementById('invNum').value = jsonData[1][1];
            if(jsonData[2] && jsonData[2][1]) selectOptionByText('customer', jsonData[2][1]);
            if(jsonData[3] && jsonData[3][1]) selectOptionByText('car', jsonData[3][1]);
            if(jsonData[4] && jsonData[4][1]) document.getElementById('date').value = jsonData[4][1];

            // 2. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
            document.querySelector('tbody').innerHTML = '';
            
            let startRow = -1;
            for(let i=0; i<jsonData.length; i++) {
                if(jsonData[i] && jsonData[i][0] == 'Ø§Ù„Ù‚Ø·Ø¹Ø©') {
                    startRow = i + 1;
                    break;
                }
            }

            if(startRow !== -1) {
                for(let i=startRow; i<jsonData.length; i++) {
                    const row = jsonData[i];
                    if(!row || row.length === 0 || row[0] === 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') break; 

                    const partName = row[0];
                    const matName = row[1];
                    const len = row[2] || 0;
                    const wid = row[3] || 0;
                    const area = row[4] || (len*wid);
                    const total = row[6] || 0;

                    const productObj = products.find(p => p.name === matName);
                    const prodId = productObj ? productObj._id : '';
                    const priceUnit = productObj ? (productObj.pricing?.unitSalePrice || 0) : 0;

                    createRow({ 
                        partName: partName, 
                        product: prodId,
                        length: len, 
                        width: wid, 
                        area: area,
                        priceUnit: priceUnit, 
                        lineTotal: total      
                    });
                }
            }
            
            // 3. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
            for(let i=jsonData.length-1; i>0; i--) {
                const row = jsonData[i];
                if(row && row[0] == 'Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©') {
                    document.getElementById('extraCost').value = row[1] || 0;
                    break;
                }
            }

            calcTotal();
            alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        };
        reader.readAsArrayBuffer(file);
    }

    function selectOptionByText(id, text) {
        const select = document.getElementById(id);
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].text === text) {
                select.selectedIndex = i;
                if(id === 'car') populateCarParts();
                break;
            }
        }
    }

    async function loadForEdit(id) {
        const res = await fetch(`${API}/sales/${id}`);
        const inv = await res.json();
        
        document.getElementById('editId').value = inv._id;
        document.getElementById('invNum').value = inv.invoiceNumber; 
        document.getElementById('customer').value = inv.customer?._id || inv.customer; 
        document.getElementById('car').value = inv.carModel?._id || inv.carModel;
        document.getElementById('serviceType').value = inv.serviceType;
        document.getElementById('date').value = inv.date.split('T')[0];
        
        document.getElementById('extraCost').value = inv.totalExtraCosts || 0;
        document.getElementById('discount').value = inv.totalDiscount || 0;
        
        if(inv.totalTax > 0) document.getElementById('hasVat').checked = true;
        if(inv.whtAmount > 0) document.getElementById('hasWht').checked = true;

        const tbody = document.querySelector('tbody');
        tbody.innerHTML = '';
        inv.items.forEach(item => {
            createRow({
                partName: item.partName,
                product: item.product?._id || item.product,
                length: item.lengthCM,
                width: item.widthCM,
                area: item.area,
                priceUnit: 0, 
                lineTotal: item.price
            });
        });
        calcTotal();
    }
</script>
</body>
</html>