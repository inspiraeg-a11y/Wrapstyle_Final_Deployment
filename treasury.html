<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f1f5f9; }
        .card { background: white; padding: 30px; border-radius: 10px; max-width: 900px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { color: #1e293b; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 15px; display: flex; justify-content: space-between; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #475569; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        select:disabled { background-color: #f3f4f6; color: #6b7280; }
        .btn-in { background: #10b981; color: white; width: 100%; padding: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 16px; border-radius: 6px; }
        .btn-out { background: #ef4444; color: white; width: 100%; padding: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 16px; border-radius: 6px; }
        .bank-box { background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
        #linkedInvoiceInfo { display:none; background:#dcfce7; color:#166534; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; font-size:14px; border:1px solid #86efac; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ’¸ Ø¥Ø°Ù† Ø­Ø±ÙƒØ© Ù†Ù‚Ø¯ÙŠØ©</h2>
    <input type="hidden" id="editId">
    <input type="hidden" id="invoiceId">
    <!-- Ø­Ù‚ÙˆÙ„ Ù…Ø®ÙÙŠØ© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <input type="hidden" id="hiddenCustName">
    <input type="hidden" id="hiddenCarInfo">
    
    <div id="linkedInvoiceInfo"></div>

    <div class="row">
        <div class="col">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
            <select id="type" onchange="updateUI()">
                <option value="Inbound">ğŸ“¥ Ø¥Ø°Ù† Ù‚Ø¨Ø¶ (ØªÙˆØ±ÙŠØ¯)</option>
                <option value="Outbound">ğŸ“¤ Ø¥Ø°Ù† ØµØ±Ù (Ø¯ÙØ¹)</option>
            </select>
        </div>
        <div class="col"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="date"></div>
        <div class="col"><label>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†</label><input id="serial" placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ" readonly></div>
    </div>

    <div class="row">
        <div class="col">
            <label id="treasuryLabel">Ø§Ù„Ø®Ø²ÙŠÙ†Ø© / Ø§Ù„Ø¨Ù†Ùƒ (Ù…Ø¯ÙŠÙ†)</label>
            <select id="treasuryAcc"><option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option></select>
        </div>
        <div class="col">
            <label id="targetLabel">Ù…Ù† Ø­Ø³Ø§Ø¨ (Ø¯Ø§Ø¦Ù†)</label>
            <select id="targetAcc"><option value="">-- Ø§Ø®ØªØ± --</option></select>
        </div>
    </div>

    <div class="row">
        <div class="col"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="amount" style="font-weight:bold;font-size:16px"></div>
        <div class="col">
            <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="payMethod" onchange="handlePaymentMethodChange()">
                <option value="Cash">Ù†Ù‚Ø¯ÙŠ (Cash)</option>
                <option value="Check">Ø´ÙŠÙƒ (Cheque)</option>
                <option value="BankTransfer">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                <option value="POS">Ø´Ø¨ÙƒØ© (POS)</option>
            </select>
        </div>
    </div>

    <div class="bank-box" id="bankDetails">
        <div class="row">
            <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label><input id="bankName"></div>
            <div class="col"><label>Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ / Ø§Ù„ØªØ­ÙˆÙŠÙ„</label><input id="checkNum"></div>
            <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input type="date" id="dueDate"></div>
        </div>
    </div>

    <div class="row">
        <div class="col"><label>Ø§Ù„Ø¨ÙŠØ§Ù† (Ø§Ù„Ø´Ø±Ø­)</label><input id="desc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©..."></div>
    </div>

    <div class="row">
        <div class="col"><label>Ø§Ù„Ù…Ø³ØªÙ„Ù…</label><input id="recv"></div>
        <div class="col"><label>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</label><input id="acc" value="Admin" readonly></div>
    </div>

    <button id="saveBtn" class="btn-in" onclick="save()">ğŸ“¥ Ø­ÙØ¸ Ø¥Ø°Ù† Ø§Ù„Ù‚Ø¨Ø¶</button>
</div>

<script>
    const API = 'http://localhost:5000/api';
    let safeAccounts = [], bankAccounts = [];
    document.getElementById('date').valueAsDate = new Date();

    window.onload = async () => {
        await loadAccounts();
        const params = new URLSearchParams(window.location.search);
        
        // Ù„Ùˆ Ø¬Ø§ÙŠ Ù…Ù† ÙØ§ØªÙˆØ±Ø© (Ø³Ø¯Ø§Ø¯)
        if(params.get('invoiceId')) {
            document.getElementById('invoiceId').value = params.get('invoiceId');
            document.getElementById('amount').value = params.get('amount');
            document.getElementById('desc').value = `Ø³Ø¯Ø§Ø¯ ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${params.get('invNum')}`;
            
            // Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const custName = params.get('custName') || '';
            const carInfo = params.get('carInfo') || '-';

            document.getElementById('hiddenCustName').value = custName;
            document.getElementById('hiddenCarInfo').value = carInfo;

            // ğŸ‘‡ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙˆØ¶ÙˆØ­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ğŸ‘‡
            document.getElementById('linkedInvoiceInfo').style.display = 'block';
            document.getElementById('linkedInvoiceInfo').innerHTML = `
                ğŸ”— <b>Ø³Ø¯Ø§Ø¯ ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${params.get('invNum')}</b><br>
                ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${custName} &nbsp; | &nbsp; ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${carInfo}
            `;
            
            // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if(params.get('custId')) {
                 setTimeout(() => document.getElementById('targetAcc').value = params.get('custId'), 500);
            }
        }
        handlePaymentMethodChange();
    };

    async function loadAccounts() {
        const res = await fetch(`${API}/accounts`);
        const all = await res.json();
        const subs = all.filter(a => a.isTransactional);
        
        safeAccounts = subs.filter(a => a.code.startsWith('1101') || a.name.includes('Ø®Ø²Ù†Ø©'));
        bankAccounts = subs.filter(a => a.code.startsWith('1102') || a.name.includes('Ø¨Ù†Ùƒ'));
        
        const oSel = document.getElementById('targetAcc');
        subs.forEach(a => oSel.innerHTML += `<option value="${a._id}">${a.name} (${a.code})</option>`);
    }

    function handlePaymentMethodChange() {
        const m = document.getElementById('payMethod').value;
        const sel = document.getElementById('treasuryAcc');
        sel.innerHTML = '';
        const list = m === 'Cash' ? safeAccounts : bankAccounts;
        list.forEach(a => sel.innerHTML += `<option value="${a._id}">${a.name}</option>`);
        document.getElementById('bankDetails').style.display = m === 'Cash' ? 'none' : 'block';
    }

    function updateUI() {
        const type = document.getElementById('type').value;
        const btn = document.getElementById('saveBtn');
        if(type === 'Inbound') {
            document.getElementById('treasuryLabel').innerText = 'Ø¥Ù„Ù‰: Ø§Ù„Ø®Ø²ÙŠÙ†Ø© (Ù…Ø¯ÙŠÙ†)';
            document.getElementById('targetLabel').innerText = 'Ù…Ù†: (Ø¯Ø§Ø¦Ù†)';
            btn.className = 'btn-in'; btn.innerText = 'ğŸ“¥ Ø­ÙØ¸ Ø¥Ø°Ù† Ø§Ù„Ù‚Ø¨Ø¶';
        } else {
            document.getElementById('treasuryLabel').innerText = 'Ù…Ù†: Ø§Ù„Ø®Ø²ÙŠÙ†Ø© (Ø¯Ø§Ø¦Ù†)';
            document.getElementById('targetLabel').innerText = 'Ø¥Ù„Ù‰: (Ù…Ø¯ÙŠÙ†)';
            btn.className = 'btn-out'; btn.innerText = 'ğŸ“¤ Ø­ÙØ¸ Ø¥Ø°Ù† Ø§Ù„ØµØ±Ù';
        }
    }

    async function save() {
        const data = {
            type: document.getElementById('type').value,
            date: document.getElementById('date').value,
            treasuryAccount: document.getElementById('treasuryAcc').value,
            targetAccount: document.getElementById('targetAcc').value,
            amount: document.getElementById('amount').value,
            paymentMethod: document.getElementById('payMethod').value,
            description: document.getElementById('desc').value,
            invoiceId: document.getElementById('invoiceId').value
        };

        try {
            const res = await fetch(`${API}/treasury`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            const json = await res.json();
            if(res.ok) {
                if(data.invoiceId && data.type === 'Inbound') {
                    // ÙØªØ­ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ù…Ø®ØµØµ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                    // Ù‡Ù†Ø§ Ø¨Ù†Ù…Ø±Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
                    const cust = document.getElementById('hiddenCustName').value;
                    const car = document.getElementById('hiddenCarInfo').value;
                    
                    const url = `payment_receipt.html?ref=${json.serialNumber}&cust=${encodeURIComponent(cust)}&car=${encodeURIComponent(car)}&amount=${data.amount}&method=${data.paymentMethod}&desc=${encodeURIComponent(data.description)}`;
                    window.open(url, '_blank');
                } else {
                    window.open(`treasury_print.html?id=${json._id}`, '_blank', 'width=800,height=600');
                }

                if(data.invoiceId) window.location.href = 'sales_list.html';
                else location.reload();
            } else { alert('Ø®Ø·Ø£: ' + json.message); }
        } catch(e) { alert('Ø®Ø·Ø£ Ø§ØªØµØ§Ù„'); }
    }
</script>
</body>
</html>