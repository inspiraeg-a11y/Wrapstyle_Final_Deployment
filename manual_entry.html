<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f1f5f9; }
        .card { background: white; padding: 30px; border-radius: 10px; max-width: 1200px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { color: #1e293b; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 5px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { background: #e0f2fe; padding: 10px; color: #0369a1; border: 1px solid #ccc; }
        td { padding: 5px; border: 1px solid #eee; }
        td input, td select { border: 1px solid #ddd; text-align: center; width: 100%; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background: #3b82f6; margin-top: 10px; }
        .btn-save { background: #10b981; width: 100%; margin-top: 20px; font-size: 16px; padding: 15px; }
        
        .diff-box { margin-top: 15px; font-weight: bold; text-align: center; padding: 15px; border-radius: 5px; font-size: 16px; }
        .balanced { background: #dcfce7; color: #166534; border: 1px solid #166534; }
        .unbalanced { background: #fee2e2; color: #991b1b; border: 1px solid #991b1b; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ ØªØ³ÙˆÙŠØ© ÙŠØ¯ÙˆÙŠ (Ù…Ø¹ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©)</h2>
    
    <div class="row">
        <div class="col"><label>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="refNo" placeholder="MAN-AUTO"></div>
        <div class="col"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="date"></div>
        <div class="col" style="flex:2"><label>Ø¨ÙŠØ§Ù† Ø§Ù„Ù‚ÙŠØ¯ (Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)</label><input id="desc" placeholder="Ù…Ø«Ø§Ù„: ØªØ³ÙˆÙŠØ© Ø¹Ù‡Ø¯Ø© Ù†Ù‚Ø¯ÙŠØ© - ØªØ³ÙˆÙŠØ© Ù…Ø®Ø²ÙˆÙ†"></div>
    </div>

    <table id="tbl">
        <thead>
            <tr>
                <th width="25%">Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                <th width="20%">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th> <!-- Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ -->
                <th width="25%">Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ</th>
                <th width="12%">Ù…Ø¯ÙŠÙ†</th>
                <th width="12%">Ø¯Ø§Ø¦Ù†</th>
                <th width="6%">x</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot style="background:#f8fafc; font-weight:bold">
            <tr>
                <td colspan="3" style="text-align:left; padding:10px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td>
                <td id="sumDebit" style="color:green">0.00</td>
                <td id="sumCredit" style="color:red">0.00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>
    <button class="btn btn-add" onclick="addRow()">+ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯</button>

    <div id="diffBox" class="diff-box balanced">âœ… Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªØ²Ù† (Ø§Ù„ÙØ±Ù‚: 0.00)</div>

    <button class="btn btn-save" onclick="save()">ğŸ’¾ Ø­ÙØ¸ ÙˆØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯</button>
</div>

<script>
    const API = 'http://localhost:5000/api';
    let accounts = [];
    let costCenters = [];

    window.onload = async () => {
        document.getElementById('date').valueAsDate = new Date();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆÙ…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©
        try {
            const [accRes, ccRes] = await Promise.all([
                fetch(`${API}/accounts`),
                fetch(`${API}/cost-centers`)
            ]);
            const dataAcc = await accRes.json();
            const dataCC = await ccRes.json();

            accounts = dataAcc.filter(a => a.isTransactional);
            costCenters = dataCC;
            
            addRow();
            addRow(); 
        } catch(e) { alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'); }
    };

    function getAccOptions() {
        return accounts.map(a => `<option value="${a._id}">${a.code} - ${a.name}</option>`).join('');
    }

    function getCCOptions() {
        return `<option value="">-- Ø¹Ø§Ù… --</option>` + 
               costCenters.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
    }

    function addRow() {
        const tbody = document.querySelector('tbody');
        const row = `<tr>
            <td><select class="acc" style="text-align:right"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ --</option>${getAccOptions()}</select></td>
            <td><select class="cc" style="background:#f0f9ff">${getCCOptions()}</select></td> <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ² -->
            <td><input class="line-desc" placeholder="Ø¨ÙŠØ§Ù† ÙØ±Ø¹ÙŠ"></td>
            <td><input type="number" class="dr" value="0" oninput="calc()"></td>
            <td><input type="number" class="cr" value="0" oninput="calc()"></td>
            <td><button style="color:red;background:none;border:none;cursor:pointer" onclick="this.closest('tr').remove();calc()">X</button></td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    function calc() {
        let dr = 0, cr = 0;
        document.querySelectorAll('.dr').forEach(i => dr += parseFloat(i.value)||0);
        document.querySelectorAll('.cr').forEach(i => cr += parseFloat(i.value)||0);
        
        document.getElementById('sumDebit').innerText = dr.toFixed(2);
        document.getElementById('sumCredit').innerText = cr.toFixed(2);
        
        const diff = dr - cr;
        const box = document.getElementById('diffBox');
        
        if(Math.abs(diff) < 0.01) {
            box.className = 'diff-box balanced';
            box.innerText = 'âœ… Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªØ²Ù†';
        } else {
            box.className = 'diff-box unbalanced';
            box.innerText = `âŒ ØºÙŠØ± Ù…ØªØ²Ù† (Ø§Ù„ÙØ±Ù‚: ${diff.toFixed(2)}) - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©`;
        }
    }

    async function save() {
        const rows = document.querySelectorAll('tbody tr');
        const lines = [];
        
        rows.forEach(tr => {
            const accId = tr.querySelector('.acc').value;
            if(accId) {
                lines.push({
                    accountId: accId,
                    accountName: tr.querySelector('.acc').selectedOptions[0].text,
                    costCenter: tr.querySelector('.cc').value || null, // Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙƒØ²
                    description: tr.querySelector('.line-desc').value,
                    debit: parseFloat(tr.querySelector('.dr').value)||0,
                    credit: parseFloat(tr.querySelector('.cr').value)||0
                });
            }
        });

        if(lines.length < 2) { alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø·Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }

        const dr = lines.reduce((s,l)=>s+l.debit,0);
        const cr = lines.reduce((s,l)=>s+l.credit,0);
        
        if(Math.abs(dr-cr) > 0.01) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸: Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªØ²Ù†!'); return; }

        const data = {
            referenceNo: document.getElementById('refNo').value,
            entryDate: document.getElementById('date').value,
            description: document.getElementById('desc').value,
            lines: lines
        };

        try {
            const res = await fetch(`${API}/journal`, {
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)
            });
            if(res.ok) {
                const json = await res.json();
                if(confirm('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚ÙŠØ¯ØŸ')) {
                    window.open(`journal_details.html?id=${json._id}`, '_blank');
                }
                window.location.href = 'journal.html';
            } else {
                const j = await res.json();
                alert('Ø®Ø·Ø£: ' + j.message);
            }
        } catch(e) { alert('Ø®Ø·Ø£ Ø§ØªØµØ§Ù„'); }
    }
</script>
</body>
</html>