<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f1f5f9; }
        .card { background: white; padding: 25px; border-radius: 10px; max-width: 1300px; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„Ø§ØªØ± */
        .filter-box { background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bae6fd; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        label { font-size: 12px; font-weight: bold; color: #0369a1; margin-bottom: 4px; }
        select, input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; min-width: 150px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size:13px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: #1e293b; color: white; }
        
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .in { background: #dcfce7; color: #166534; }
        .out { background: #fee2e2; color: #991b1b; }
        
        .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; color: white; margin: 0 2px; }
        .btn-edit { background: #f59e0b; } .btn-del { background: #ef4444; } .btn-print { background: #333; }
        .btn-new { background: #10b981; padding: 8px 15px; font-size: 14px; font-weight: bold; text-decoration:none; margin-left:5px; }
        .btn-search { background: #0284c7; font-weight: bold; color: white; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="display:flex; justify-content:space-between; align-items:center; margin-top:0; color:#333; border-bottom:1px solid #eee; padding-bottom:15px;">
        ğŸ“œ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²Ù† (ÙˆØ§Ø±Ø¯ / ØµØ§Ø¯Ø±)
        <div>
            <a href="stock_in.html" class="btn-new">ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯</a>
            <a href="stock_out.html" class="btn-new" style="background:#ef4444">âœ‚ï¸ ØµØ±Ù Ø¬Ø¯ÙŠØ¯</a>
        </div>
    </h2>
    
    <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div class="filter-box">
        <div class="filter-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
            <select id="fType" onchange="applyFilter()">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option value="Inbound">ÙˆØ§Ø±Ø¯ (Ø§Ø³ØªÙ„Ø§Ù…)</option>
                <option value="Outbound">ØµØ§Ø¯Ø± (ØµØ±Ù)</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Ø§Ù„Ù…Ø®Ø²Ù†</label>
            <select id="fWarehouse" onchange="applyFilter()">
                <option value="">Ø§Ù„ÙƒÙ„</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Ø¨Ø­Ø« (Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù† / Ø§Ù„Ù…Ø±Ø¬Ø¹)</label>
            <input id="fSearch" placeholder="TRX... / INV..." onkeyup="applyFilter()">
        </div>
        <div class="filter-group">
            <button class="btn btn-search" onclick="applyFilter()">ğŸ” Ø¨Ø­Ø« ÙˆØªØ­Ø¯ÙŠØ«</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ù…Ø®Ø²Ù†</th>
                <th>Ø§Ù„Ù…Ø±Ø¬Ø¹ / Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<script>
    const API = 'http://localhost:5000/api';
    let allTransactions = [];
    
    window.onload = async () => {
        // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ù„Ù„ÙÙ„ØªØ±
        try {
            const whRes = await fetch(`${API}/warehouses`);
            const warehouses = await whRes.json();
            const sel = document.getElementById('fWarehouse');
            warehouses.forEach(w => {
                sel.innerHTML += `<option value="${w.path}">${w.path}</option>`;
            });
        } catch(e) {}

        // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª
        try {
            const res = await fetch(`${API}/stock`);
            allTransactions = await res.json();
            applyFilter();
        } catch(e) { alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); }
    };

    function applyFilter() {
        const type = document.getElementById('fType').value;
        const wh = document.getElementById('fWarehouse').value;
        const search = document.getElementById('fSearch').value.toLowerCase();

        const filtered = allTransactions.filter(t => {
            if (type && t.type !== type) return false;
            if (wh && (!t.warehouse || !t.warehouse.includes(wh))) return false;
            if (search && !t.serialNumber.toLowerCase().includes(search) && 
                !(t.supplierDoc||'').toLowerCase().includes(search) && 
                !(t.carName||'').toLowerCase().includes(search)) return false;
            return true;
        });

        renderTable(filtered);
    }

    function renderTable(list) {
        const tbody = document.getElementById('tbody');
        if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>'; return; }

        tbody.innerHTML = list.map(t => {
            const editPage = t.type === 'Inbound' ? 'stock_in.html' : 'stock_out.html';
            return `
            <tr>
                <td style="font-weight:bold">${t.serialNumber}</td>
                <td>${new Date(t.date).toLocaleDateString('ar-EG')}</td>
                <td><span class="badge ${t.type==='Inbound'?'in':'out'}">${t.type==='Inbound'?'Ø§Ø³ØªÙ„Ø§Ù…':'ØµØ±Ù'}</span></td>
                <td>${t.warehouse || 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ'}</td>
                <td>${t.supplierDoc || t.carName || '-'}</td>
                <td>${t.items.length}</td>
                <td>
                    <button class="btn btn-print" onclick="window.open('stock_print.html?id=${t._id}','_blank','width=800,height=600')">ğŸ–¨ï¸</button>
                    <button class="btn btn-edit" onclick="location.href='${editPage}?id=${t._id}'">âœï¸</button>
                    <button class="btn btn-del" onclick="del('${t._id}', '${t.type}')">ğŸ—‘ï¸</button>
                </td>
            </tr>
        `}).join('');
    }

    async function del(id, type) {
        const msg = type === 'Inbound' ? 'Ø³Ø­Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯' : 'Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ø±ØµÙŠØ¯';
        if(!confirm(`ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… ${msg} ÙˆØ¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯!`)) return;
        
        try {
            const res = await fetch(`${API}/stock/${id}`, { method: 'DELETE' });
            if(res.ok) { alert('ØªÙ… Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØµØ­ÙŠØ­ âœ…'); window.location.reload(); }
        } catch(e) { alert('Ø®Ø·Ø£ Ø§ØªØµØ§Ù„'); }
    }
</script>
</body>
</html>