<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø°Ù† ØµØ±Ù Ø®Ø§Ù…Ø§Øª</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f1f5f9; }
        .paper { background: white; padding: 30px; max-width: 1100px; margin: 0 auto; border-top: 5px solid #ef4444; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #f3f4f6; }
        input, select { width: 100%; border: none; text-align: center; background: transparent; box-sizing: border-box; }
        input[readonly] { background: #f8fafc; cursor: not-allowed; font-weight: bold; color: #555; }
        .header-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; background: #f8fafc; padding: 10px; border-radius: 5px; }
        .btn-load { background: #3b82f6; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-save { background: #ef4444; color: white; padding: 10px; width: 100%; border: none; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        #msg { display: none; padding: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="paper">
    <h2>âœ‚ï¸ Ø¥Ø°Ù† ØµØ±Ù Ø®Ø§Ù…Ø§Øª (Ù„Ø£Ù…Ø± ØªØ´ØºÙŠÙ„)</h2>
    <div id="msg"></div>
    
    <div class="header-grid">
        <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="outDate"></div>
        <div><label>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ù†</label><input id="outSerial" placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ"></div>
        
        <div>
            <label>Ù…Ù† Ù…Ø®Ø²Ù†</label>
            <select id="outWarehouse" style="border:1px solid #ccc; background:white">
                <option value="">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
            </select>
        </div>

        <div style="grid-column: 1 / -1; display:flex; align-items:center; gap:10px; background:#e0f2fe; padding:8px; border-radius:5px;">
            <label style="color:#0369a1; width:180px; font-weight:bold;">ğŸ”— Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´ØºÙ„ (Ø§Ù„ÙØ§ØªÙˆØ±Ø©):</label>
            <input id="outJobOrderRef" placeholder="INV-..." style="border:1px solid #ccc; background:white; width: 100%; padding:5px;">
            <button class="btn-load" onclick="loadInvoiceItems()">Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø·Ø¹</button>
        </div>

        <div><label>Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><input id="outCar" placeholder="-" readonly></div>
        <div><label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="outCustomer" placeholder="-" readonly></div>
    </div>

    <table id="tbl">
        <thead>
            <tr>
                <th width="20%">Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                <th width="20%">Ø§Ù„ØµÙ†Ù</th>
                <th width="15%">ÙƒÙˆØ¯ Ø§Ù„Ø±ÙˆÙ„ (Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†)</th>
                <th width="10%">Ø§Ù„Ø·ÙˆÙ„</th>
                <th width="10%">Ø§Ù„Ø¹Ø±Ø¶</th>
                <th width="15%">Ø§Ù„Ù…Ø³Ø§Ø­Ø©</th>
                <th width="5%">X</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <button class="btn-save" onclick="save()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµØ±Ù</button>
</div>

<script>
    const API = 'http://localhost:5000/api';
    document.getElementById('outDate').valueAsDate = new Date();

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø²Ù†
    window.onload = async () => {
        try {
            const whRes = await fetch(`${API}/warehouses/transactional`);
            const warehouses = await whRes.json();
            const whSelect = document.getElementById('outWarehouse');
            
            if (warehouses.length > 0) {
                whSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø²Ù† --</option>';
                warehouses.forEach(w => {
                    // ğŸ‘‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: value=ID
                    whSelect.innerHTML += `<option value="${w._id}">${w.path}</option>`;
                });
            } else {
                whSelect.innerHTML = '<option value="">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ø²Ù†</option>';
            }
        } catch(e) {}
    };

    async function loadInvoiceItems() {
        const jobNum = document.getElementById('outJobOrderRef').value;
        if (!jobNum) { alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©'); return; }
        
        try {
            const res = await fetch(`${API}/sales/job-order/${jobNum}`);
            if (!res.ok) throw new Error('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            const invoice = await res.json();
            
            document.getElementById('outCar').value = invoice.carModel ? `${invoice.carModel.brand} ${invoice.carModel.model}` : '-';
            document.getElementById('outCustomer').value = invoice.customer?.name || '';
            
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = ''; 

            for (const item of invoice.items) {
                const len = item.lengthCM || item.length || 0;
                const wid = item.widthCM || item.width || 0;
                const area = item.area || (len * wid);

                await addRow(
                    item.partName, 
                    item.product?._id, 
                    item.productName || item.product?.name, 
                    len, wid, area
                );
            }
        } catch(e) { showMsg('Ø®Ø·Ø£: ' + e.message, 'red'); }
    }

    async function addRow(partName, prodId, prodName, len, wid, area) { 
        const tbody = document.querySelector('tbody');
        let rollOptions = '<option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
        
        try {
            const res = await fetch(`${API}/stock/available-rolls?productId=${prodId}`);
            const rolls = await res.json();
            rollOptions = rolls.length > 0 
                ? '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø±ÙˆÙ„ --</option>' + rolls.map(r => `<option value="${r}">${r}</option>`).join('')
                : '<option value="">(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯)</option>';
        } catch(e) { rollOptions = '<option value="">Ø®Ø·Ø£</option>'; }

        const row = `<tr>
            <td><input value="${partName || 'Ù‚Ø·Ø¹Ø©'}" readonly style="font-weight:bold"></td> 
            <td><input value="${prodName}" readonly><input type="hidden" class="prod-id" value="${prodId}"></td>
            <td><select class="roll-code-select" style="border:1px solid #3b82f6; background:#e0f2fe">${rollOptions}</select></td> 
            <td><input class="len-input" value="${len}" readonly style="color:blue"></td>
            <td><input class="wid-input" value="${wid}" readonly style="color:blue"></td>
            <td><input class="area-output" value="${area}" readonly style="font-weight:bold; color:#059669"></td>
            <td style="cursor:pointer; color:red" onclick="this.closest('tr').remove()">X</td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    async function save() {
        const jobOrderRef = document.getElementById('outJobOrderRef').value;
        const warehouse = document.getElementById('outWarehouse').value;
        
        if (!jobOrderRef) { showMsg('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„', 'red'); return; }
        if (!warehouse) { showMsg('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø²Ù†', 'red'); return; }

        const rows = document.querySelectorAll('tbody tr');
        const items = [];
        
        rows.forEach(tr => {
            const rollCode = tr.querySelector('.roll-code-select').value;
            items.push({
                product: tr.querySelector('.prod-id').value,
                rollCode: rollCode || 'General',
                partName: tr.querySelectorAll('input')[0].value,
                consumedLength: parseFloat(tr.querySelector('.len-input').value) || 0,
                consumedWidth: parseFloat(tr.querySelector('.wid-input').value) || 0,
                consumedArea: parseFloat(tr.querySelector('.area-output').value) || 0
            });
        });

        const data = {
            type: 'Outbound',
            serialNumber: document.getElementById('outSerial').value,
            date: document.getElementById('outDate').value,
            jobOrder: jobOrderRef, 
            warehouse: warehouse, 
            carName: document.getElementById('outCar').value,
            items: items
        };

        try {
            const res = await fetch(`${API}/stock`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
            if(res.ok) {
                showMsg('âœ… ØªÙ… Ø§Ù„ØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­!', 'green');
                setTimeout(() => location.reload(), 2000);
            } else {
                const json = await res.json();
                showMsg('Ø®Ø·Ø£: ' + json.message, 'red');
            }
        } catch(e) { showMsg('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'red'); }
    }

    function showMsg(text, color) {
        const msg = document.getElementById('msg');
        msg.innerText = text;
        msg.style.display = 'block';
        msg.style.background = color === 'green' ? '#dcfce7' : '#fee2e2';
        msg.style.color = color === 'green' ? '#166534' : '#991b1b';
        setTimeout(() => msg.style.display = 'none', 4000);
    }
</script>
</body>
</html>