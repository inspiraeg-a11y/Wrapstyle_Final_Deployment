<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…ÙˆØ±Ø¯</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f1f5f9; }
        
        .card { background: white; padding: 30px; border-radius: 10px; max-width: 1000px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            body { background: white; padding: 0; }
            .card { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0; }
            .no-print { display: none !important; }
            h2 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
            table { border: 1px solid #000; }
            th, td { border: 1px solid #000 !important; }
        }

        h2 { color: #1e293b; margin-top: 0; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }
        
        .filter-box { display: flex; gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .filter-box select { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { background: #1e293b; color: white; padding: 12px; text-align: center; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        tr:nth-child(even) { background-color: #f9fafb; }

        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-print { background: #3b82f6; }
        .btn-search { background: #10b981; }

        .balance-positive { color: #166534; font-weight: bold; } /* Ù„Ù‡ ÙÙ„ÙˆØ³ */
        .balance-negative { color: #991b1b; font-weight: bold; } /* Ø¹Ù„ÙŠÙ‡ ÙÙ„ÙˆØ³ (Ù†Ø§Ø¯Ø±Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†) */
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“œ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…ÙˆØ±Ø¯ ØªÙØµÙŠÙ„ÙŠ</h2>
    
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙÙ„ØªØ± (ØªØ®ØªÙÙŠ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
    <div class="filter-box no-print">
        <select id="supplierSelect">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯ --</option>
        </select>
        <button class="btn btn-search" onclick="getStatement()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù</button>
        <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

    <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <div id="reportHeader" style="display:none; margin-bottom:20px;">
        <strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> <span id="rName"></span> <br>
        <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</strong> <span id="rDate"></span>
    </div>

    <table id="statementTable">
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¨ÙŠØ§Ù† / Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                <th>Ù…Ø¯ÙŠÙ† (ØµØ±Ù)</th>
                <th>Ø¯Ø§Ø¦Ù† (ÙØ§ØªÙˆØ±Ø©)</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5" style="padding:20px; color:#666">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ±Ø¯ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
        </tbody>
        <tfoot style="background:#f1f5f9; font-weight:bold; display:none" id="tableFooter">
            <tr>
                <td colspan="4" style="text-align:left; padding:10px;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù„Ù„Ù…ÙˆØ±Ø¯:</td>
                <td id="finalBal" style="font-size:16px;">0.00</td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
    const API = 'http://localhost:5000/api';
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    window.onload = async () => {
        document.getElementById('rDate').innerText = new Date().toLocaleDateString('ar-EG');
        try {
            const res = await fetch(`${API}/suppliers`);
            const data = await res.json();
            const sel = document.getElementById('supplierSelect');
            data.forEach(s => {
                sel.innerHTML += `<option value="${s._id}">${s.name}</option>`;
            });
        } catch(e) { alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†'); }
    };

    async function getStatement() {
        const supplierId = document.getElementById('supplierSelect').value;
        if (!supplierId) { alert('Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£ÙˆÙ„Ø§Ù‹'); return; }

        try {
            const res = await fetch(`${API}/reports/supplier-statement/${supplierId}`);
            if (!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            
            const data = await res.json();
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('rName').innerText = data.supplierName;
            document.getElementById('reportHeader').style.display = 'block';
            document.getElementById('tableFooter').style.display = 'table-row-group';
            
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';

            if (data.transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯</td></tr>';
                document.getElementById('finalBal').innerText = '0.00';
                return;
            }

            data.transactions.forEach(t => {
                const row = `<tr>
                    <td>${new Date(t.date).toLocaleDateString('ar-EG')}</td>
                    <td>${t.desc} ${t.ref ? '('+t.ref+')' : ''}</td>
                    <td style="color:#ef4444">${t.debit > 0 ? t.debit.toLocaleString() : '-'}</td>
                    <td style="color:#10b981">${t.credit > 0 ? t.credit.toLocaleString() : '-'}</td>
                    <td style="font-weight:bold">${t.balance.toLocaleString()}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            document.getElementById('finalBal').innerText = data.finalBalance.toLocaleString() + ' Ø¬.Ù…';

        } catch(e) {
            alert('ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…Ø±Ø¨ÙˆØ· Ø¨Ø­Ø³Ø§Ø¨ Ù…Ø§Ù„ÙŠ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª');
        }
    }
</script>
</body>
</html>