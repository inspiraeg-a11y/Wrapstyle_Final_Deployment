<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f1f5f9; }
        .card { background: white; padding: 25px; border-radius: 10px; max-width: 1200px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size:14px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: #e0f2fe; color: #0369a1; }
        .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; margin: 0 2px; font-size:12px; }
        .btn-edit { background: #f59e0b; }
        .btn-del { background: #ef4444; }
        .btn-pay { background: #10b981; font-weight: bold; } /* Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø¯Ø§Ø¯ */
        .btn-new { background: #10b981; padding: 10px 20px; text-decoration: none; display: inline-block; font-weight: bold; }
        .paid-badge { background: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 10px; font-size: 11px; }
        .unpaid-badge { background: #fee2e2; color: #991b1b; padding: 3px 8px; border-radius: 10px; font-size: 11px; }
        .btn-print { background: #333; } /* Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    </style>
</head>
<body>
<div class="card">
    <h2 style="display:flex; justify-content:space-between">
        ğŸ“‹ Ø³Ø¬Ù„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        <a href="sales_invoice.html" class="btn-new">+ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
    </h2>
    <table>
        <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
        <tbody id="tbody"></tbody>
    </table>
</div>
<script>
    const API = 'http://localhost:5000/api';
    
    async function load() {
        try {
            const res = await fetch(`${API}/sales`);
            if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            const data = await res.json();
            
            if (!data || data.length === 0) {
                document.getElementById('tbody').innerHTML = '<tr><td colspan="6" style="padding:20px;color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                return;
            }

            document.getElementById('tbody').innerHTML = data.map(i => {
                const isPaid = i.paymentStatus === 'Paid' || (i.paidAmount >= i.finalTotal);
                
                // Ø±Ø§Ø¨Ø· Ø§Ù„Ø³Ø¯Ø§Ø¯: Ø¨ÙŠØ¨Ø¹Øª Ø§Ù„Ù€ ID ÙˆØ§Ù„Ù…Ø¨Ù„Øº ÙˆØ±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø²Ù†Ø©
                const custId = i.customer?.accountId || '';
                const custName = encodeURIComponent(i.customer?.name || '');
                const carInfo = encodeURIComponent(i.carModel ? `${i.carModel.brand} ${i.carModel.model}` : '-');
                const payLink = `treasury.html?invoiceId=${i._id}&invNum=${i.invoiceNumber}&amount=${i.finalTotal}&type=Inbound&custId=${custId}&custName=${custName}&carInfo=${carInfo}`;
                
                return `
                <tr>
                    <td>${i.invoiceNumber}</td>
                    <td>${new Date(i.date).toLocaleDateString('ar-EG')}</td>
                    <td>${i.customer?.name || '-'}</td>
                    <td style="font-weight:bold; color:green">${parseFloat(i.finalTotal).toLocaleString()}</td>
                    <td><span class="${isPaid?'paid-badge':'unpaid-badge'}">${isPaid?'Ù…Ø¯ÙÙˆØ¹':'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}</span></td>
                    <td>
                        ${!isPaid ? `<button class="btn btn-pay" onclick="location.href='${payLink}'">ğŸ’° Ø³Ø¯Ø§Ø¯</button>` : ''}
                        <button class="btn btn-edit" onclick="location.href='sales_invoice.html?id=${i._id}'">âœï¸</button>
                        <button class="btn btn-print" onclick="printInvoice('${i._id}')">ğŸ–¨ï¸</button>
                        <button class="btn btn-del" onclick="del('${i._id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>
                `;
            }).join('');
        } catch(e) { alert('Ø®Ø·Ø£: ' + e.message); }
    }

    async function del(id) {
        if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ ÙˆØ¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²Ù†.')) return;
        try {
            const res = await fetch(`${API}/sales/${id}`, { method: 'DELETE' });
            if(res.ok) { alert('ØªÙ… Ø§Ù„Ø­Ø°Ù ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ âœ…'); load(); }
            else { 
                const err = await res.json();
                alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + err.message); 
            }
        } catch(e) { alert('Ø®Ø·Ø£ Ø§ØªØµØ§Ù„'); }
    }

    function printInvoice(id) {
        // ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ ÙØªØ­ ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ù…Ø®ØµØµØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØªØŒ Ø£Ùˆ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        // Ø³Ù†ÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø¹ØªØ§Ø¯ ÙÙŠ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
        // window.open(`invoice_print.html?id=${id}`, '_blank', 'width=800,height=600');
        alert('Ø®Ø§ØµÙŠØ© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡Ø§ Ù…Ù† Ù‡Ù†Ø§Ùƒ.');
    }

    load();
</script>
</body>
</html>