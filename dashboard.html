<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø© (CSS Variables) */
        :root {
            --primary: #4f46e5; /* Ø§Ù„Ù…ÙˆÙ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
            --bg: #f8fafc;
            --text: #334155;
            --card-bg: #ffffff;
            --shadow: rgba(0,0,0,0.05);
        }

        /* Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø£Ø®Ø¶Ø± */
        [data-theme="green"] {
            --primary: #059669;
            --bg: #f0fdf4;
            --text: #064e3b;
        }

        /* Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø£Ø³ÙˆØ¯ (Dark Mode) */
        [data-theme="dark"] {
            --primary: #6366f1;
            --bg: #0f172a;
            --text: #f8fafc;
            --card-bg: #1e293b;
            --shadow: rgba(0,0,0,0.3);
        }

        body { font-family: 'Cairo', sans-serif; padding: 20px; background-color: var(--bg); color: var(--text); transition: 0.3s; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .settings-btn { background: var(--card-bg); border: 1px solid #ccc; padding: 10px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px var(--shadow); font-size: 20px; }
        
        /* Ø´Ø¨ÙƒØ© Ø§Ù„ÙƒØ±ÙˆØª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .stat-card { 
            background: var(--card-bg); padding: 20px; border-radius: 15px; 
            box-shadow: 0 4px 15px var(--shadow); 
            border-bottom: 4px solid var(--primary);
            transition: 0.3s; display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù„Ø­Ø¯ Ù…Ø§ Ù†ÙØ¹Ù„Ù‡ */
        }
        .stat-card.visible { display: flex; align-items: center; gap: 15px; }
        .stat-card:hover { transform: translateY(-5px); }

        .icon-box { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; background: rgba(0,0,0,0.05); }
        .stat-info h3 { margin: 0; font-size: 13px; opacity: 0.8; }
        .stat-info .num { font-size: 24px; font-weight: 800; margin-top: 5px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Modal) */
        .settings-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999; display: none;
            justify-content: center; align-items: center;
        }
        .settings-content {
            background: var(--card-bg); padding: 30px; border-radius: 15px; width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); color: var(--text);
        }
        .color-options { display: flex; gap: 10px; margin: 15px 0; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-circle.selected { border-color: #333; transform: scale(1.1); }

        .toggle-item { display: flex; justify-content: space-between; margin: 10px 0; padding: 5px 0; border-bottom: 1px solid #eee; }
        
        .charts-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .chart-box { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px var(--shadow); }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>ğŸ‘‹ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h1>
            <p>Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ù†Ø´Ø§Ø·Ùƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</p>
        </div>
        <button class="settings-btn" onclick="openSettings()">âš™ï¸ ØªØ®ØµÙŠØµ</button>
    </div>

    <!-- Ø§Ù„ÙƒØ±ÙˆØª (Ù‡ØªØ¸Ù‡Ø± ÙˆØªØ®ØªÙÙŠ Ø­Ø³Ø¨ Ù…Ø²Ø§Ø¬Ùƒ) -->
    <div class="stats-grid">
        <div class="stat-card" id="card-sales" data-default="true">
            <div class="icon-box">ğŸ›’</div>
            <div class="stat-info"><h3>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±</h3><div class="num" id="val-sales">0.00</div></div>
        </div>
        <div class="stat-card" id="card-cash" data-default="true">
            <div class="icon-box">ğŸ’µ</div>
            <div class="stat-info"><h3>Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h3><div class="num" id="val-cash">0.00</div></div>
        </div>
        <div class="stat-card" id="card-stock" data-default="true">
            <div class="icon-box">ğŸ“¦</div>
            <div class="stat-info"><h3>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3><div class="num" id="val-stock">0.00</div></div>
        </div>
        <div class="stat-card" id="card-receivables" data-default="false">
            <div class="icon-box">ğŸ“‰</div>
            <div class="stat-info"><h3>Ù„Ù†Ø§ (Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø¹Ù…Ù„Ø§Ø¡)</h3><div class="num" id="val-receivables">0.00</div></div>
        </div>
        <div class="stat-card" id="card-payables" data-default="false">
            <div class="icon-box">ğŸ“ˆ</div>
            <div class="stat-info"><h3>Ø¹Ù„ÙŠÙ†Ø§ (Ù…ÙˆØ±Ø¯ÙŠÙ†)</h3><div class="num" id="val-payables">0.00</div></div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
        <div class="chart-box"><canvas id="pieChart"></canvas></div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-content">
            <h3>ğŸ¨ Ø§Ø®ØªØ± Ù…Ø²Ø§Ø¬Ùƒ (Ø§Ù„Ù„ÙˆÙ†)</h3>
            <div class="color-options">
                <div class="color-circle" style="background:#4f46e5" onclick="setTheme('default')"></div>
                <div class="color-circle" style="background:#059669" onclick="setTheme('green')"></div>
                <div class="color-circle" style="background:#1e293b" onclick="setTheme('dark')"></div>
            </div>

            <h3>ğŸ‘ï¸ Ø§Ø®ØªØ± Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù„ÙŠ ØªØ¸Ù‡Ø±</h3>
            <div class="toggle-item">
                <span>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±</span> <input type="checkbox" id="chk-sales" onchange="saveWidgets()">
            </div>
            <div class="toggle-item">
                <span>Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</span> <input type="checkbox" id="chk-cash" onchange="saveWidgets()">
            </div>
            <div class="toggle-item">
                <span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span> <input type="checkbox" id="chk-stock" onchange="saveWidgets()">
            </div>
            <div class="toggle-item">
                <span>Ù„Ù†Ø§ (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)</span> <input type="checkbox" id="chk-receivables" onchange="saveWidgets()">
            </div>
            <div class="toggle-item">
                <span>Ø¹Ù„ÙŠÙ†Ø§ (Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†)</span> <input type="checkbox" id="chk-payables" onchange="saveWidgets()">
            </div>

            <button onclick="closeSettings()" style="width:100%; padding:10px; margin-top:15px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const API = 'http://localhost:5000/api';

        // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        window.onload = async () => {
            loadTheme();
            loadWidgets();
            await fetchData();
        };

        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        async function fetchData() {
            try {
                const res = await fetch(`${API}/reports/dashboard-stats`);
                const data = await res.json();

                document.getElementById('val-sales').innerText = data.sales.total.toLocaleString();
                document.getElementById('val-cash').innerText = data.cash.toLocaleString();
                document.getElementById('val-stock').innerText = data.stock.toLocaleString();
                document.getElementById('val-receivables').innerText = data.receivables.toLocaleString();
                document.getElementById('val-payables').innerText = data.payables.toLocaleString();

                initCharts(data);
            } catch(e) { console.log('Error fetching stats'); }
        }

        // 3. Ø§Ù„Ø«ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }
        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'default';
            document.documentElement.setAttribute('data-theme', saved);
        }

        // 4. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒØ±ÙˆØª (Ø§Ù„Ø²ÙŠØªÙˆÙ†Ø©)
        function openSettings() {
            document.getElementById('settingsPanel').style.display = 'flex';
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Checkboxes
            ['sales','cash','stock','receivables','payables'].forEach(key => {
                const isVisible = localStorage.getItem(`widget_${key}`) !== 'hidden';
                document.getElementById(`chk-${key}`).checked = isVisible;
            });
        }
        function closeSettings() { document.getElementById('settingsPanel').style.display = 'none'; }

        function saveWidgets() {
            ['sales','cash','stock','receivables','payables'].forEach(key => {
                const chk = document.getElementById(`chk-${key}`);
                const card = document.getElementById(`card-${key}`);
                
                if(chk.checked) {
                    card.classList.add('visible');
                    localStorage.setItem(`widget_${key}`, 'visible');
                } else {
                    card.classList.remove('visible');
                    localStorage.setItem(`widget_${key}`, 'hidden');
                }
            });
        }
        
        function loadWidgets() {
            ['sales','cash','stock','receivables','payables'].forEach(key => {
                const saved = localStorage.getItem(`widget_${key}`);
                const card = document.getElementById(`card-${key}`);
                // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø£ÙˆÙ„ 3 Ø¸Ø§Ù‡Ø±ÙŠÙ†ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù…Ø®ÙÙŠØŒ Ø¥Ù„Ø§ Ù„Ùˆ Ø§Ù„ÙŠÙˆØ²Ø± ØºÙŠØ±
                const isDefaultVisible = card.getAttribute('data-default') === 'true';
                
                if(saved === 'visible' || (saved === null && isDefaultVisible)) {
                    card.classList.add('visible');
                } else {
                    card.classList.remove('visible');
                }
            });
        }

        // 5. Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        function initCharts(data) {
            const ctx1 = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Ø£Ø³Ø¨ÙˆØ¹ 1', 'Ø£Ø³Ø¨ÙˆØ¹ 2', 'Ø£Ø³Ø¨ÙˆØ¹ 3', 'Ø£Ø³Ø¨ÙˆØ¹ 4'],
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                        data: [10000, 15000, 8000, data.sales.total],
                        borderColor: '#4f46e5',
                        fill: true,
                        backgroundColor: 'rgba(79, 70, 229, 0.1)'
                    }]
                },
                options: { responsive: true }
            });

            const ctx2 = document.getElementById('pieChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Ù…Ø®Ø²ÙˆÙ†', 'Ù†Ù‚Ø¯ÙŠØ©', 'Ø¯ÙŠÙˆÙ†'],
                    datasets: [{
                        data: [data.stock, data.cash, data.receivables],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b']
                    }]
                }
            });
        }
    </script>
</body>
</html>