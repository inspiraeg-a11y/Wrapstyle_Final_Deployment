<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªØ­Ù„ÙŠÙ„ Ø±Ø¨Ø­ÙŠØ© Ø£Ù…Ø± Ø§Ù„Ø´ØºÙ„</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f1f5f9; }
        .card { background: white; padding: 25px; border-radius: 10px; max-width: 1000px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .search-box { display: flex; gap: 10px; margin-bottom: 30px; background: #e0f2fe; padding: 20px; border-radius: 8px; justify-content: center; }
        .search-box input { padding: 10px; width: 300px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; text-align: center; }
        .btn-search { background: #0284c7; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .result-section { display: none; }
        .stats-grid { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; padding: 20px; border-radius: 10px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .bg-rev { background: linear-gradient(135deg, #10b981, #059669); } .bg-cost { background: linear-gradient(135deg, #ef4444, #b91c1c); } .bg-profit { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .stat-title { font-size: 14px; opacity: 0.9; margin-bottom: 5px; display: block; } .stat-val { font-size: 28px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th { background: #f1f5f9; padding: 10px; color: #475569; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
    </style>
</head>
<body>
<div class="card">
    <h2 style="text-align:center; color:#1e293b">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø±Ø¨Ø­ÙŠØ© Ø£Ù…Ø± Ø§Ù„Ø´ØºÙ„ (Job Costing)</h2>
    <div class="search-box">
        <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
        <input id="invNum" placeholder="Ù…Ø«Ø§Ù„: INV-173...">
        <button class="btn-search" onclick="analyze()">ØªØ­Ù„ÙŠÙ„ ğŸ”</button>
    </div>
    <div id="result" class="result-section">
        <div class="stats-grid">
            <div class="stat-card bg-rev"><span class="stat-title">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</span><span class="stat-val" id="revVal">0.00</span></div>
            <div class="stat-card bg-cost"><span class="stat-title">Ø§Ù„ØªÙƒÙ„ÙØ©</span><span class="stat-val" id="costVal">0.00</span></div>
            <div class="stat-card bg-profit"><span class="stat-title">Ø§Ù„Ø±Ø¨Ø­</span><span class="stat-val" id="profitVal">0.00</span></div>
        </div>
        <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø§Ù…Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ©</h3>
        <table><thead><tr><th>ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø°Ù†</th><th>ØµÙ†Ù</th><th>Ù‚Ø·Ø¹Ø©</th><th>Ø±ÙˆÙ„</th><th>Ù…Ø³Ø§Ø­Ø©</th><th>ØªÙƒÙ„ÙØ©</th></tr></thead><tbody id="tbody"></tbody></table>
    </div>
</div>
<script>
    const API = 'http://localhost:5000/api';
    async function analyze() {
        const invNum = document.getElementById('invNum').value.trim();
        if (!invNum) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
        try {
            const res = await fetch(`${API}/reports/job-profitability/${encodeURIComponent(invNum)}`);
            if (!res.ok) throw new Error('Ø®Ø·Ø£');
            const data = await res.json();
            document.getElementById('result').style.display = 'block';
            document.getElementById('revVal').innerText = data.financials.revenue.toLocaleString();
            document.getElementById('costVal').innerText = data.financials.cost.toLocaleString();
            document.getElementById('profitVal').innerText = data.financials.profit.toLocaleString();
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';
            if (data.materials.length === 0) tbody.innerHTML = '<tr><td colspan="7" style="padding:20px;color:red">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµØ±Ù Ù…Ø®Ø²Ù†ÙŠ</td></tr>';
            else data.materials.forEach(m => {
                tbody.innerHTML += `<tr><td>${new Date(m.date).toLocaleDateString('ar-EG')}</td><td>${m.trxSerial}</td><td>${m.product}</td><td>${m.partName||'-'}</td><td>${m.rollCode}</td><td>${m.area}</td><td style="font-weight:bold;color:red">${m.cost.toFixed(2)}</td></tr>`;
            });
        } catch(e) { alert('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£'); }
    }
</script>
</body>
</html>